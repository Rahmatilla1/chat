const express=require("express"),http=require("http"),WebSocket=require("ws"),fs=require("fs"),cors=require("cors"),webpush=require("web-push"),PORT=process.env.PORT||4001,publicVapidKey="BE2xPCwCk9wNYrH8Z0SXxzp4ZbkTTi1YqTpdhYyp67hjgiql0Fpr0zieO4kujvtrAi4z0ZARTRgh0mx7_g21Qww",privateVapidKey="utwzQSnnIS_xi_u2IP4xbuamgLSNYwKkJbTF_0zfh7w";webpush.setVapidDetails("mailto:youremail@example.com","BE2xPCwCk9wNYrH8Z0SXxzp4ZbkTTi1YqTpdhYyp67hjgiql0Fpr0zieO4kujvtrAi4z0ZARTRgh0mx7_g21Qww","utwzQSnnIS_xi_u2IP4xbuamgLSNYwKkJbTF_0zfh7w");const app=express();app.use(express.json()),app.use(cors());const USERS_FILE="users.json",CHATS_FILE="chats.json",sessions={};let users=[],chats={};const sockets={};fs.existsSync(USERS_FILE)&&(users=JSON.parse(fs.readFileSync(USERS_FILE,"utf-8"))),fs.existsSync(CHATS_FILE)&&(chats=JSON.parse(fs.readFileSync(CHATS_FILE,"utf-8")));let subscriptions=[];function sendPushNotification(s,e){let t=JSON.stringify({title:s,body:e});subscriptions.forEach(s=>{webpush.sendNotification(s,t).catch(()=>{})})}function generateToken(){return Math.random().toString(36).substr(2,16)}function notifyUser(s){sockets[s]&&sockets[s].send(JSON.stringify({type:"new_message"}))}app.post("/subscribe",(s,e)=>{let t=s.body;db.saveSubscription(t),e.status(201).json({})}),app.post("/register",(s,e)=>{let{username:t,password:r}=s.body;if(users.find(s=>s.username===t))return e.status(400).json({error:"Username already exists"});users.push({username:t,password:r}),fs.writeFileSync(USERS_FILE,JSON.stringify(users,null,2)),e.json({success:!0})}),app.post("/login",(s,e)=>{let{username:t,password:r}=s.body,n=users.find(s=>s.username===t&&s.password===r);if(!n)return e.status(401).json({error:"Invalid credentials"});let o=generateToken();sessions[o]=t,e.json({token:o,username:t})}),app.get("/users",(s,e)=>{e.json(users.map(s=>({username:s.username})))}),app.get("/chat/:withUser",(s,e)=>{let t=s.headers.authorization,r=sessions[t];if(!r)return e.status(401).json({error:"Unauthorized"});let n=s.params.withUser,o=[r,n].sort().join("|");e.json(chats[o]||[])}),app.post("/chat/send",(s,e)=>{let t=s.headers.authorization,r=sessions[t];if(!r)return e.status(401).json({error:"Unauthorized"});let{to:n,text:o}=s.body,i=[r,n].sort().join("|");chats[i]||(chats[i]=[]),chats[i].push({from:r,to:n,text:o,time:Date.now()}),fs.writeFileSync(CHATS_FILE,JSON.stringify(chats,null,2)),notifyUser(n),notifyUser(r),sendPushNotification("Yangi xabar!","Sizga yangi xabar keldi."),e.json({success:!0})}),app.post("/chat/delete",(s,e)=>{let t=s.headers.authorization,r=sessions[t];if(!r)return e.status(401).json({error:"Unauthorized"});let{to:n,index:o}=s.body,i=[r,n].sort().join("|");return!chats[i]||"number"!=typeof o||o<0||o>=chats[i].length?e.status(400).json({error:"Invalid index"}):chats[i][o].from!==r?e.status(403).json({error:"Faqat o‘z xabaringizni o‘chira olasiz"}):void(chats[i].splice(o,1),fs.writeFileSync(CHATS_FILE,JSON.stringify(chats,null,2)),e.json({success:!0}))}),app.post("/user/delete",(s,e)=>{let t=s.headers.authorization,r=sessions[t];if(!r)return e.status(401).json({error:"Unauthorized"});users=users.filter(s=>s.username!==r),fs.writeFileSync(USERS_FILE,JSON.stringify(users,null,2)),Object.keys(chats).forEach(s=>{s.includes(r)&&delete chats[s]}),fs.writeFileSync(CHATS_FILE,JSON.stringify(chats,null,2)),delete sessions[t],e.json({success:!0})}),app.post("/logout",(s,e)=>{let t=s.headers.authorization;if(t&&sessions[t])return delete sessions[t],e.json({success:!0,message:"Logout bo‘ldingiz"});e.status(401).json({success:!1,error:"Avtorizatsiya xatosi"})});const server=http.createServer(app),wss=new WebSocket.Server({server});wss.on("connection",function(s){s.on("message",function(e){try{let t=JSON.parse(e);"auth"===t.type&&t.token&&sessions[t.token]&&(s.username=sessions[t.token],sockets[s.username]=s)}catch(r){}}),s.on("close",function(){s.username&&delete sockets[s.username]})}),server.listen(PORT,()=>{console.log(`Server ${PORT}-portda ishlayapti`)});